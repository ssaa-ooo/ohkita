<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>宿泊予約カレンダー</title>
  <style>
    body {
      font-family: -apple-system, sans-serif;
      background-color: transparent;
      color: #37352f;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      width: 100%;
      max-width: 450px;
    }

    /* カレンダーのデザイン */
    .calendar-wrapper {
      margin-bottom: 30px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .calendar-header {
      text-align: center;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 1.1em;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      text-align: center;
    }
    .day-name {
      font-size: 0.8em;
      color: #888;
      padding-bottom: 5px;
    }
    .day {
      padding: 8px 0;
      font-size: 0.9em;
      cursor: pointer;
      border-radius: 4px;
      background-color: #f7f7f5;
    }
    .day:hover {
      background-color: #e0e0e0;
    }
    
    /* 満室（予約済み）のスタイル */
    .day.full {
      background-color: #ffcccc; /* 赤背景 */
      color: #cc0000;
      cursor: not-allowed;
      text-decoration: line-through;
    }
    
    /* 選択中のスタイル */
    .day.selected {
      background-color: #333;
      color: white;
    }

    /* 空白の日（月またぎ） */
    .day.empty {
      background-color: transparent;
      cursor: default;
    }

    /* フォーム周り */
    label { font-weight: 600; font-size: 14px; display: block; margin-top: 15px; }
    input { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
    button { margin-top: 20px; width: 100%; padding: 12px; background-color: #333; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
    button:disabled { background-color: #ccc; }
    .message { margin-top: 15px; text-align: center; font-size: 14px; }
  </style>
</head>
<body>

  <div class="container">
    <div class="calendar-wrapper">
      <div id="calendar-title" class="calendar-header">Loading...</div>
      <div id="calendar-grid" class="calendar-grid"></div>
    </div>

    <form id="bookingForm">
      <label>宿泊希望日（上のカレンダーから選択）</label>
      <input type="date" id="date" required readonly> <label>お名前</label>
      <input type="text" id="name" required placeholder="山田 太郎">

      <label>メールアドレス</label>
      <input type="email" id="email" required placeholder="sample@example.com">

      <button type="submit" id="submitBtn">予約を申し込む</button>
      <div id="msg" class="message"></div>
    </form>
  </div>

  <script>
    // ★ GASのURLをここに貼り付け
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxEAyH8M7lsEuUO5HPpTqyzUbfiiYFzlsiWuVWF6FPT9OHZvZYO2ZCZNIKscI-oLTnUrA/exec";

    let busyDates = []; // 予約済みリスト
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth(); // 0始まり

    // 初期化処理
    window.onload = async function() {
      await fetchBusyDates();
      renderCalendar(currentYear, currentMonth);
    };

    // GASから予約済みの日付を取得
    async function fetchBusyDates() {
      try {
        const res = await fetch(GAS_URL + '?type=json', { redirect: "follow" }); // GETリクエスト
        const data = await res.json();
        busyDates = data; // ["2023-12-01", "2023-12-05"...]
      } catch (e) {
        console.error("カレンダー取得エラー", e);
      }
    }

    // カレンダー描画
    function renderCalendar(year, month) {
      const grid = document.getElementById('calendar-grid');
      const title = document.getElementById('calendar-title');
      grid.innerHTML = "";
      
      // タイトル更新
      title.textContent = `${year}年 ${month + 1}月`;

      // 曜日の表示
      const days = ['日', '月', '火', '水', '木', '金', '土'];
      days.forEach(d => {
        const div = document.createElement('div');
        div.className = 'day-name';
        div.textContent = d;
        grid.appendChild(div);
      });

      // 月の初日の曜日と、日数を計算
      const firstDay = new Date(year, month, 1).getDay();
      const lastDate = new Date(year, month + 1, 0).getDate();

      // 空白セルを作成（1日が始まる前の空白）
      for (let i = 0; i < firstDay; i++) {
        const div = document.createElement('div');
        div.className = 'day empty';
        grid.appendChild(div);
      }

      // 日付セルを作成
      for (let d = 1; d <= lastDate; d++) {
        const div = document.createElement('div');
        div.className = 'day';
        div.textContent = d;

        // 日付文字列を作成 (YYYY-MM-DD)
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

        // 満室チェック
        if (busyDates.includes(dateStr)) {
          div.classList.add('full');
          div.title = "満室";
        } else {
          // 空室の場合のクリックイベント
          div.onclick = () => selectDate(dateStr, div);
        }

        grid.appendChild(div);
      }
    }

    // 日付選択時の処理
    function selectDate(dateStr, element) {
      // フォームに入力
      document.getElementById('date').value = dateStr;
      
      // 選択状態の見た目を更新
      document.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
      element.classList.add('selected');
    }

    // 予約送信処理（前回と同じ）
    document.getElementById('bookingForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      const msg = document.getElementById('msg');
      btn.disabled = true;
      btn.textContent = "送信中...";

      const payload = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        date: document.getElementById('date').value
      };

      fetch(GAS_URL, {
        method: 'POST',
        redirect: "follow",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "text/plain;charset=utf-8" }
      })
      .then(res => res.json())
      .then(data => {
        if(data.result === 'success'){
          msg.textContent = "予約完了！カレンダーを更新します...";
          msg.style.color = "green";
          document.getElementById('bookingForm').reset();
          // 送信後に最新の予約状況を再取得
          setTimeout(() => { location.reload(); }, 2000); 
        } else {
          throw new Error('Err');
        }
      })
      .catch(err => {
        msg.textContent = "送信失敗";
        btn.disabled = false;
      });
    });
  </script>
</body>
</html>